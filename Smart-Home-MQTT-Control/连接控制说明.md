### **MQTT 控制说明**

**连接信息：**

```c
#define MQTT_BROKER_HOST "120.55.192.74"
#define MQTT_BROKER_PORT 1883
#define MQTT_KEEPALIVE 60
#define MQTT_USERNAME "test"
#define MQTT_PASSWORD "123456"
#define MQTT_SUB_QOS 1
```

---

#### **1. 控制灯光 (LED)**

- **主题 (Topic):** `smart_home/light`
- **控制命令:**
  ```json
  { "led": <编号>, "state": "<状态>" }
  ```
  - `"led"`: 灯的编号 (整数 `1`-`4`)。
  - `"state"`: `"ON"` (开) 或 `"OFF"` (关)。
- **示例 (打开 2 号灯):**
  ```json
  { "led": 2, "state": "ON" }
  ```
- **查询命令:**
  ```json
  { "command": "list" }
  ```
- **设备回复:**
  ```json
  {
    "command": "list_response",
    "status": "ok",
    "lights": [
      {"id": 1, "state": "ON", "brightness": 100, "color_temp": 6500},
      {"id": 2, "state": "OFF", "brightness": 80, "color_temp": 4000}
    ]
  }
  ```

---

#### **2. 控制报警器 (蜂鸣器)**

- **主题 (Topic):** `smart_home/alarm`
- **控制命令:**
  ```json
  { "state": "<状态>" }
  ```
  - `"state"`: `"ON"` (响) 或 `"OFF"` (停)。
- **示例 (开启报警器):**
  ```json
  { "state": "ON" }
  ```
- **查询命令:**
  ```json
  { "command": "list" }
  ```
- **设备回复:**
  ```json
  {
    "command": "list_response",
    "status": "ok",
    "state": "ON",
    "mode": 1
  }
  ```

---

### **3. 文件操作**

所有文件操作都通过 **单个主题** `smart_home/file` 进行双向通信。客户端发送命令，设备在该主题上回复响应。

- **通信主题 (Topic):** `smart_home/file`

---

#### **3.1 获取文件列表**

- **动作:** 请求设备 `media` 目录下的所有文件名。
- **客户端发送:**
  ```json
  { "command": "list" }
  ```
- **设备回复:**
  - **成功:**
    ```json
    {
      "command": "list_response",
      "status": "ok",
      "files": ["video1.mp4", "image.jpg", "log.txt"]
    }
    ```
  - **失败 (例如目录无法访问):**
    ```json
    {
      "command": "list_response",
      "status": "error",
      "message": "Cannot open media directory."
    }
    ```

---

#### **3.2 删除文件**

- **动作:** 删除 `media` 目录下的一个指定文件。
- **客户端发送:**
  ```json
  { "command": "delete", "filename": "log.txt" }
  ```
- **设备回复:**
  - **成功:**
    ```json
    {
      "command": "delete_response",
      "filename": "log.txt",
      "status": "ok"
    }
    ```
  - **失败 (文件不存在或权限问题):**
    ```json
    {
      "command": "delete_response",
      "filename": "log.txt",
      "status": "error",
      "message": "File not found or permission denied."
    }
    ```

---

#### **3.3 下载文件**

下载过程是：客户端发送一个请求，设备将文件内容分块（chunk）编码后，在多个消息中发回。

1.  **客户端发送下载请求**
    ```json
    { "command": "get", "filename": "image.jpg" }
    ```
2.  **设备分块回复文件数据**
    - 设备会向 `smart_home/file` 主题 **连续发布** 多个消息，每个消息包含一部分文件数据。
    - 客户端需要 **持续接收并拼接** 所有数据块，直到收到 `eof: true` 的消息为止。
    - **文件数据块消息格式:**
      ```json
      {
        "command": "get_response",
        "filename": "image.jpg",
        "status": "ok",
        "payload": "<Base64编码的文件块>",
        "seq": 0,
        "eof": false
      }
      ```
    - **最后一个文件块消息格式:**
      ```json
      {
        "command": "get_response",
        "filename": "image.jpg",
        "status": "ok",
        "payload": "<Base64编码的最后一块文件数据>",
        "seq": 5,
        "eof": true
      }
      ```
    - **失败 (文件不存在):**
      ```json
      {
        "command": "get_response",
        "filename": "image.jpg",
        "status": "error",
        "message": "File not found."
      }
      ```

---

#### **3.4 上传文件**

上传过程是：客户端将文件分块编码后，在多个消息中发送给设备。

1.  **客户端分块发送文件**

    - 客户端读取文件，将其分割成块（例如每块 3KB），进行 Base64 编码。
    - 为每个数据块发布一条消息到 `smart_home/file` 主题。
    - **文件数据块消息格式:**
      ```json
      {
        "command": "put",
        "filename": "new_video.mp4",
        "payload": "<Base64编码的文件块>",
        "seq": 0,
        "eof": false
      }
      ```
    - **最后一个文件块消息格式:**
      ```json
      {
        "command": "put",
        "filename": "new_video.mp4",
        "payload": "<Base64编码的最后一块文件数据>",
        "seq": 10,
        "eof": true
      }
      ```
      > **`seq`** 是从 `0` 开始的块序列号。
      > **`eof`** (End Of File) 标志位在最后一个块时必须为 `true`。

2.  **设备在接收到最后一个块后进行回复**
    - **成功:**
      ```json
      {
        "command": "put_response",
        "filename": "new_video.mp4",
        "status": "ok",
        "message": "File uploaded successfully."
      }
      ```
    - **失败 (如无法写入文件):**
      ```json
      {
        "command": "put_response",
        "filename": "new_video.mp4",
        "status": "error",
        "message": "Failed to open file for writing."
      }
      ```